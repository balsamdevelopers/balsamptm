<!DOCTYPE html>
<html>
<head>
  <title>PTM Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .controls {
      margin-bottom: 20px;
    }
    select {
      padding: 10px;
      font-size: 16px;
      width: 200px;
    }
    .schedule {
      display: grid;
      gap: 10px;
    }
    .time-slot {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .current {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .next {
      background-color: #fff3cd;
      border-color: #ffeaa7;
    }
    .completed {
      background-color: #f8f9fa;
      color: #6c757d;
    }
    .slot-time {
      font-weight: bold;
      min-width: 100px;
    }
    .student-info {
      flex-grow: 1;
      margin-left: 20px;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .current .status-indicator {
      background-color: #28a745;
    }
    .next .status-indicator {
      background-color: #ffc107;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PTM Teacher Dashboard</h2>
    
    <div class="controls">
      <label for="classSelect">Select Class & Section:</label>
      <select id="classSelect" onchange="loadSchedule()">
        <option value="">-- Select Class --</option>
        <!-- Options will be populated dynamically -->
      </select>
    </div>
    
    <div id="schedule" class="schedule">
      <!-- Schedule will be populated here -->
    </div>
  </div>

  <script>
    let currentSchedule = [];
    let updateInterval;
    
    // Load class options and initial data
    function initializeDashboard() {
      loadClassOptions();
      loadSchedule();
    }
    
    function loadClassOptions() {
      // This would typically come from your student data
      // For now, we'll use a placeholder - you should populate this dynamically
      const classes = ['1A', '1B', '2A', '2B', '3A', '3B']; // Example classes
      const classSelect = document.getElementById('classSelect');
      
      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
      });
    }
    
    function loadSchedule() {
      const classSection = document.getElementById('classSelect').value;
      if (!classSection) {
        document.getElementById('schedule').innerHTML = '<p>Please select a class to view the schedule.</p>';
        return;
      }
      
      google.script.run
        .withSuccessHandler(displaySchedule)
        .withFailureHandler(showError)
        .getTeacherData(classSection);
    }
    
    function displaySchedule(schedule) {
      currentSchedule = schedule;
      const scheduleDiv = document.getElementById('schedule');
      
      if (schedule.length === 0) {
        scheduleDiv.innerHTML = '<p>No bookings for this class yet.</p>';
        return;
      }
      
      // Sort schedule by time
      schedule.sort((a, b) => {
        const timeA = a.timeSlot.split(':').map(Number);
        const timeB = b.timeSlot.split(':').map(Number);
        return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
      });
      
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      let html = '';
      let foundCurrent = false;
      
      schedule.forEach((slot, index) => {
        const slotTime = slot.timeSlot.split(':').map(Number);
        const slotMinutes = slotTime[0] * 60 + slotTime[1];
        
        let className = '';
        let isCurrent = false;
        
        if (!foundCurrent && slotMinutes <= currentTime && currentTime < slotMinutes + 10) {
          className = 'current';
          foundCurrent = true;
          isCurrent = true;
        } else if (!foundCurrent && slotMinutes > currentTime) {
          if (index === 0 || schedule[index - 1].timeSlot.split(':').map(Number)[0] * 60 + schedule[index - 1].timeSlot.split(':').map(Number)[1] <= currentTime) {
            className = 'next';
            foundCurrent = true;
          }
        } else if (slotMinutes + 10 <= currentTime) {
          className = 'completed';
        }
        
        html += `
          <div class="time-slot ${className}" data-slot="${slot.timeSlot}">
            <div class="status-indicator"></div>
            <div class="slot-time">${slot.displaySlot}</div>
            <div class="student-info">
              <strong>${slot.studentName}</strong>
            </div>
          </div>
        `;
        
        // Play sound for current slot
        if (isCurrent) {
          playNotificationSound();
        }
      });
      
      scheduleDiv.innerHTML = html;
    }
    
    function playNotificationSound() {
      // Create a simple beep sound
      const context = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = context.createOscillator();
      const gainNode = context.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(context.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, context.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.5);
      
      oscillator.start(context.currentTime);
      oscillator.stop(context.currentTime + 0.5);
    }
    
    function showError(error) {
      console.error('Error:', error);
      document.getElementById('schedule').innerHTML = '<p>Error loading schedule. Please try again.</p>';
    }
    
    // Auto-refresh every 30 seconds
    function startAutoRefresh() {
      updateInterval = setInterval(loadSchedule, 30000);
    }
    
    // Initialize dashboard when page loads
    window.onload = function() {
      initializeDashboard();
      startAutoRefresh();
    };
    
    // Clean up on page unload
    window.onunload = function() {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
    };
  </script>
</body>
</html>
