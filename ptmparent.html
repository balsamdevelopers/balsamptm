<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTM Time Slot System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #4f46e5; --secondary-color: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .current-slot { background-color: #10b981; color: white; } /* Green */
        .next-slot { background-color: #f59e0b; color: white; } /* Yellow/Amber */
        .booked-slot { background-color: #fef3c7; color: #92400e; }
        .header-button.active { background-color: var(--primary-color); color: white; }
    </style>
</head>
<body>

    <!-- Main Container -->
    <div class="min-h-screen p-4 sm:p-8 flex justify-center items-start">
        <div class="w-full max-w-4xl">

            <!-- Header and View Selector -->
            <header class="bg-white p-4 rounded-xl card mb-6 flex justify-center shadow-lg">
                <button id="parentViewBtn" onclick="showView('parent')" class="header-button px-6 py-2 mx-2 rounded-lg font-semibold text-lg transition duration-200 active">
                    Parent PTM Booking
                </button>
                <button id="teacherViewBtn" onclick="showView('teacher')" class="header-button px-6 py-2 mx-2 rounded-lg font-semibold text-lg text-gray-600 hover:bg-gray-100 transition duration-200">
                    Teacher Dashboard
                </button>
            </header>

            <!-- Parent View -->
            <div id="parentView" class="view">
                <div class="card bg-white p-6 rounded-xl">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Welcome to PTM Check-in</h1>

                    <!-- Student Search Form -->
                    <div class="mb-6">
                        <label for="studentNameInput" class="block text-lg font-medium text-gray-700 mb-2">
                            Enter the first few letters of your ward's name:
                        </label>
                        <input type="text" id="studentNameInput" oninput="handleSearch()" placeholder="Start typing the student name..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        
                        <!-- Suggestions Dropdown -->
                        <div id="suggestionsList" class="mt-2 bg-white rounded-lg border border-gray-200 max-h-48 overflow-y-auto shadow-md z-10 relative">
                            <!-- Suggestions will appear here -->
                        </div>
                    </div>

                    <!-- Selected Student Details & Booking Button -->
                    <div id="studentDetails" class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 hidden mb-6">
                        <p class="text-lg font-semibold text-indigo-800">Selected Student:</p>
                        <p>Name: <span id="s_name" class="font-bold"></span></p>
                        <p>Class & Section: <span id="s_class" class="font-bold"></span></p>
                        <p>Admission No: <span id="s_adm" class="font-bold"></span></p>

                        <button onclick="bookTimeSlot()" id="bookButton"
                            class="mt-4 w-full bg-green-600 text-white py-3 rounded-lg font-semibold text-xl hover:bg-green-700 transition duration-150 transform hover:scale-[1.01] disabled:bg-gray-400">
                            Check-in & Get Time Slot
                        </button>
                    </div>

                    <!-- Result Display -->
                    <div id="resultMessage" class="mt-8 p-6 rounded-xl text-center text-xl font-semibold hidden transition duration-500">
                        <!-- Result message will appear here -->
                    </div>
                </div>
            </div>

            <!-- Teacher View -->
            <div id="teacherView" class="view hidden">
                <div class="card bg-white p-6 rounded-xl">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Teacher Dashboard</h1>

                    <!-- Class Selector -->
                    <div class="mb-6 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <label for="classSelect" class="text-lg font-medium text-gray-700">Select Class:</label>
                        <select id="classSelect" onchange="fetchDashboardData()"
                            class="flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Options will be populated by JS for demonstration -->
                        </select>
                    </div>

                    <!-- Status Display -->
                    <div id="dashboardStatus" class="text-center text-lg font-medium mb-4 text-gray-500">
                        Loading live data...
                    </div>

                    <!-- Slots List -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Time Slot</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="slotsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Slots will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // CRITICAL: Replace this with your actual Google Apps Script (GAS) Web App URL
        // Example: 'https://script.google.com/macros/s/AKfycbz_XXXXXXXXXX/exec'
        const GAS_WEB_APP_URL = "https://your-deployed-google-apps-script-url/exec";

        // Mock data for demonstration purposes. YOU MUST CONNECT TO GAS
        const mockStudentData = [
            { name: "Aarav Sharma", classSection: "9 A", admissionNo: "2021001" },
            { name: "Benita Kaur", classSection: "9 A", admissionNo: "2021002" },
            { name: "Chirag Patel", classSection: "10 C", admissionNo: "2020050" },
            { name: "Deepika Singh", classSection: "10 C", admissionNo: "2020051" },
            { name: "Eshan Malik", classSection: "9 B", admissionNo: "2021020" },
        ];

        // Mock dashboard data structure (simulates data read from Sheet 2 by GAS)
        let mockBookings = [
            { timeSlot: "9:30 AM", timeSlot24: "09:30", studentName: "N/A", classSection: "N/A", status: "Available" },
            { timeSlot: "9:35 AM", timeSlot24: "09:35", studentName: "Benita Kaur", classSection: "9 A", status: "Booked" },
            { timeSlot: "9:40 AM", timeSlot24: "09:40", studentName: "Chirag Patel", classSection: "10 C", status: "Booked" },
            { timeSlot: "9:45 AM", timeSlot24: "09:45", studentName: "N/A", classSection: "N/A", status: "Available" },
            { timeSlot: "12:00 PM", timeSlot24: "12:00", studentName: "Deepika Singh", classSection: "10 C", status: "Booked" },
            { timeSlot: "12:05 PM", timeSlot24: "12:05", studentName: "N/A", classSection: "N/A", status: "Available" },
            { timeSlot: "1:30 PM", timeSlot24: "13:30", studentName: "N/A", classSection: "N/A", status: "Available" },
        ];
        
        // Initial setup variables
        let selectedStudent = null;
        let dashboardInterval;

        // --- View Management ---

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.header-button').forEach(el => el.classList.remove('active'));
            
            if (viewName === 'parent') {
                document.getElementById('parentView').classList.remove('hidden');
                document.getElementById('parentViewBtn').classList.add('active');
                if (dashboardInterval) {
                    clearInterval(dashboardInterval);
                }
            } else if (viewName === 'teacher') {
                document.getElementById('teacherView').classList.remove('hidden');
                document.getElementById('teacherViewBtn').classList.add('active');
                // Ensure class select is populated and start polling
                populateClassSelect();
                fetchDashboardData();
                startDashboardPolling();
            }
        }

        // --- Parent Logic ---

        function handleSearch() {
            const input = document.getElementById('studentNameInput').value.toLowerCase().trim();
            const list = document.getElementById('suggestionsList');
            list.innerHTML = '';
            document.getElementById('studentDetails').classList.add('hidden');
            selectedStudent = null;
            document.getElementById('resultMessage').classList.add('hidden');

            if (input.length < 2) return;

            // 1. MOCK API Call (Replace with actual fetch to GAS /search endpoint)
            const filtered = mockStudentData.filter(student => student.name.toLowerCase().startsWith(input));

            if (filtered.length > 0) {
                filtered.forEach(student => {
                    const item = document.createElement('div');
                    item.className = 'px-4 py-3 cursor-pointer hover:bg-indigo-100 transition duration-100 border-b border-gray-100 last:border-b-0';
                    item.textContent = `${student.name} (${student.classSection})`;
                    item.onclick = () => selectStudent(student);
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<div class="px-4 py-3 text-gray-500">No students found.</div>';
            }
        }

        function selectStudent(student) {
            selectedStudent = student;
            document.getElementById('studentNameInput').value = student.name;
            document.getElementById('suggestionsList').innerHTML = '';

            document.getElementById('s_name').textContent = student.name;
            document.getElementById('s_class').textContent = student.classSection;
            document.getElementById('s_adm').textContent = student.admissionNo;
            
            document.getElementById('studentDetails').classList.remove('hidden');
        }

        async function bookTimeSlot() {
            if (!selectedStudent) {
                alert("Please select a student name first.");
                return;
            }

            document.getElementById('bookButton').disabled = true;
            document.getElementById('bookButton').textContent = 'Booking Slot...';
            document.getElementById('resultMessage').classList.add('hidden');
            
            const name = encodeURIComponent(selectedStudent.name);
            const classSection = encodeURIComponent(selectedStudent.classSection);
            const admNo = encodeURIComponent(selectedStudent.admissionNo);

            // 2. ACTUAL API CALL (Fetch to GAS /book endpoint)
            // The GAS Script is responsible for finding the next available slot after Current Time + 15 min buffer.
            try {
                // *** This is a mock API call for demonstration. Replace with actual fetch: ***
                // const response = await fetch(`${GAS_WEB_APP_URL}?action=book&name=${name}&class=${classSection}&adm=${admNo}`);
                // const result = await response.json();
                
                // MOCK SIMULATION:
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                const mockResult = { 
                    success: true, 
                    bookedSlot: "1:30 PM", // Replace with real slot from GAS
                    studentName: selectedStudent.name
                };

                if (mockResult.success) {
                    const msgEl = document.getElementById('resultMessage');
                    msgEl.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                    msgEl.classList.add('bg-green-100', 'text-green-700');
                    msgEl.innerHTML = `
                        <p class="text-2xl font-bold mb-2">Check-in Successful!</p>
                        <p>Your time slot to meet the teacher is:</p>
                        <p class="text-4xl text-green-700 mt-2">${mockResult.bookedSlot}</p>
                        <p class="mt-4 text-base">Please proceed to the respective classroom at your scheduled time.</p>
                    `;
                    // Update mock data for teacher dashboard
                    const booked = mockBookings.find(b => b.timeSlot === mockResult.bookedSlot);
                    if (booked) {
                        booked.status = "Booked";
                        booked.studentName = selectedStudent.name;
                        booked.classSection = selectedStudent.classSection;
                    }

                } else {
                    const msgEl = document.getElementById('resultMessage');
                    msgEl.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                    msgEl.classList.add('bg-red-100', 'text-red-700');
                    msgEl.textContent = mockResult.message || "Failed to book slot. Please try again.";
                }

            } catch (error) {
                console.error('Booking Error:', error);
                const msgEl = document.getElementById('resultMessage');
                msgEl.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                msgEl.classList.add('bg-red-100', 'text-red-700');
                msgEl.textContent = "An error occurred during check-in.";
            } finally {
                document.getElementById('bookButton').disabled = false;
                document.getElementById('bookButton').textContent = 'Check-in & Get Time Slot';
            }
        }

        // --- Teacher Logic ---

        function populateClassSelect() {
            const select = document.getElementById('classSelect');
            const classes = [...new Set(mockStudentData.map(s => s.classSection))].sort();
            select.innerHTML = '<option value="">Select a Class</option>';
            classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                select.appendChild(option);
            });
            // Auto-select the first class for quick dashboard view
            if (classes.length > 0) {
                select.value = classes[0];
            }
        }

        function startDashboardPolling() {
            // Poll every 10 seconds to keep the dashboard live
            if (dashboardInterval) clearInterval(dashboardInterval);
            dashboardInterval = setInterval(fetchDashboardData, 10000);
            console.log("Dashboard polling started.");
        }

        async function fetchDashboardData() {
            const selectedClass = document.getElementById('classSelect').value;
            const statusDiv = document.getElementById('dashboardStatus');

            if (!selectedClass) {
                statusDiv.textContent = 'Please select a class to view the schedule.';
                document.getElementById('slotsTableBody').innerHTML = '';
                return;
            }

            statusDiv.textContent = 'Fetching data...';

            // 3. ACTUAL API CALL (Fetch to GAS /dashboard endpoint)
            // The GAS Script is expected to return ALL slots for the selected class.
            try {
                // *** This is a mock API call for demonstration. Replace with actual fetch: ***
                // const response = await fetch(`${GAS_WEB_APP_URL}?action=dashboard&class=${encodeURIComponent(selectedClass)}`);
                // const data = await response.json();
                
                // MOCK SIMULATION (filtering mockBookings by selected class)
                await new Promise(resolve => setTimeout(resolve, 500)); 
                const data = mockBookings.filter(b => b.classSection === selectedClass || b.classSection === "N/A").sort((a, b) => {
                    return a.timeSlot24.localeCompare(b.timeSlot24); // Sort by time (24h format)
                });
                
                renderDashboard(data);
                statusDiv.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Dashboard Fetch Error:', error);
                statusDiv.textContent = 'Error loading data. Check console.';
            }
        }

        function renderDashboard(slots) {
            const tbody = document.getElementById('slotsTableBody');
            tbody.innerHTML = '';
            
            // Get current time rounded up to the nearest 5 minutes
            const now = new Date();
            const roundedMinutes = Math.ceil(now.getMinutes() / 5) * 5;
            now.setMinutes(roundedMinutes);
            now.setSeconds(0);
            
            // Function to convert time string (e.g., '9:30 AM') to a comparable Date object
            function timeToDate(timeStr) {
                const date = new Date();
                let [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');

                if (hours === '12') hours = '0'; // Midnight edge case

                if (modifier === 'PM') {
                    hours = parseInt(hours, 10) + 12;
                }
                date.setHours(hours, minutes, 0, 0);
                return date;
            }

            let currentSlotIndex = -1;
            let nextSlotIndex = -1;

            // 1. Determine Current and Next slots based on real time
            for (let i = 0; i < slots.length; i++) {
                const slot = slots[i];
                if (slot.status !== 'Booked') continue;

                const slotStart = timeToDate(slot.timeSlot);
                const slotEnd = new Date(slotStart.getTime() + 5 * 60000); // Slot ends 5 minutes later

                // Is the current time inside this slot? (Current slot is 5 min long)
                if (now >= slotStart && now < slotEnd) {
                    currentSlotIndex = i;
                    nextSlotIndex = i + 1; // Immediate next slot
                    break;
                }
                
                // If not current, check if it's the very next one that hasn't started yet
                if (now < slotStart && nextSlotIndex === -1) {
                    nextSlotIndex = i;
                    // If we find the first upcoming slot, we can stop looking for 'next'
                    // The 'current' check above is prioritized.
                }

                // If a slot has passed, and we haven't found a current slot, check for the end bell
                if (now >= slotEnd && slot.status === 'Booked') {
                    // Check if the current time is exactly the end time, or very close (e.g., within 10 seconds)
                    const timeDifference = Math.abs(now.getTime() - slotEnd.getTime());
                    if (timeDifference < 10000) { // If within 10 seconds of slot end
                        playBellSound(slot.timeSlot);
                    }
                }
            }
            
            // 2. Render the table rows
            slots.forEach((slot, index) => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150';

                let rowClass = '';
                let statusText = slot.status === 'Booked' ? 'Booked' : 'Available';
                let studentName = slot.studentName === 'N/A' ? '-' : slot.studentName;

                if (index === currentSlotIndex) {
                    rowClass = 'current-slot font-bold';
                    statusText = 'CURRENT MEETING';
                } else if (index === nextSlotIndex) {
                    rowClass = 'next-slot font-bold';
                    statusText = 'NEXT UP';
                } else if (slot.status === 'Booked') {
                    rowClass = 'booked-slot';
                }

                row.className = row.className + ' ' + rowClass;

                // Time Slot Column
                let cell1 = row.insertCell();
                cell1.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium';
                cell1.textContent = slot.timeSlot;

                // Student Name Column (Color coded via row background)
                let cell2 = row.insertCell();
                cell2.className = 'px-6 py-4 whitespace-nowrap text-sm';
                cell2.textContent = studentName;

                // Status Column
                let cell3 = row.insertCell();
                cell3.className = 'px-6 py-4 whitespace-nowrap text-sm font-semibold';
                cell3.textContent = statusText;
            });
        }

        // --- Audio Logic ---

        let lastBellTime = 0; // Prevent rapid re-triggering of the bell

        function playBellSound(slotTime) {
            const now = Date.now();
            // Only play if the bell hasn't played in the last 15 seconds (to avoid spam)
            if (now - lastBellTime < 15000) return;
            lastBellTime = now;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note

            // Bell effect: short ramp up and immediate drop
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05); // Quick volume increase
            gainNode.gain.linearRampToValueAtTime(0.0, audioContext.currentTime + 0.5); // Quick decay

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5); // Sound lasts 0.5 seconds
            
            console.log(`BELL SOUND: Slot ${slotTime} has ended.`);
        }

        // Initialize App
        window.onload = () => {
            showView('parent'); // Start on the Parent View
        };

    </script>
</body>
</html>


